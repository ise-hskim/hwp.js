# 스트림 구조

각 스트림의 내부 구조와 데이터 구성에 대한 상세 설명입니다.

## FileHeader 스트림 구조

FileHeader는 정확히 256바이트의 고정 크기를 가집니다:

```
오프셋  크기   필드명              설명
0       32     signature          파일 시그니처 "HWP Document File\0\0\0..."
32      4      version            파일 버전 (0x05000000 = 5.0.0.0)
36      4      flags              속성 플래그
40      4      reserved1          예약
44      4      reserved2          예약
48      4      reserved3          예약
52      4      reserved4          예약
56      4      encryptVersion     암호화 버전
60      1      encryptMethod      암호화 방법
61      195    reserved           예약 (0으로 채움)
```

### Flags 필드 비트 구성
- bit 0: 압축 (DocInfo)
- bit 1: 암호화
- bit 2: 배포용 문서
- bit 3: 스크립트 포함
- bit 4: DRM 보안
- bit 5: XMLTemplate 포함
- bit 6: 문서 이력 포함
- bit 7: 전자 서명
- bit 8: 공인 인증서 암호화
- bit 9: 전자 서명 예약 저장
- bit 10: 공인 인증서 DRM
- bit 11: CCL 문서

## DocInfo 스트림 구조

DocInfo는 레코드 기반 구조를 사용합니다:

```
[레코드 1]
[레코드 2]
...
[레코드 n]
```

각 레코드의 기본 구조:
```
struct Record {
    DWORD tagId;       // 레코드 태그 ID (10비트 태그 + 10비트 레벨 + 12비트 크기)
    BYTE data[size];   // 레코드 데이터 (size는 tagId에서 추출)
}
```

### 주요 레코드 종류
- HWPTAG_DOCUMENT_PROPERTIES (0x00)
- HWPTAG_ID_MAPPINGS (0x01)
- HWPTAG_BIN_DATA (0x02)
- HWPTAG_FACE_NAME (0x03)
- HWPTAG_BORDER_FILL (0x04)
- HWPTAG_CHAR_SHAPE (0x05)
- HWPTAG_TAB_DEF (0x06)
- HWPTAG_NUMBERING (0x07)
- HWPTAG_BULLET (0x08)
- HWPTAG_PARA_SHAPE (0x09)
- HWPTAG_STYLE (0x0A)

## BodyText/Section 스트림 구조

각 Section 스트림도 레코드 기반 구조를 사용합니다:

```
[문단 리스트 헤더]
[문단 1]
  [문단 헤더]
  [텍스트]
  [컨트롤 객체들]
[문단 2]
  ...
```

### 문단 구조
```
struct Paragraph {
    ParaHeader header;     // 문단 헤더
    ParaText text;        // 텍스트 정보
    ParaCharShape charShapes;  // 글자 모양 정보
    ParaLineSeg lineSegs;     // 줄 정보
    Control controls[];    // 컨트롤 객체들
}
```

### 컨트롤 객체 종류
- 표 (Table)
- 그림 (Picture)
- 그리기 객체 (Drawing Object)
- OLE 객체
- 수식 (Equation)
- 양식 객체 (Form Object)
- 하이퍼링크
- 책갈피

## 레코드 태그 구조

32비트 태그의 비트 구성:
```
31-22: 태그 ID (10비트)
21-12: 레벨 (10비트)
11-0:  크기 (12비트, 4095까지)
```

크기가 4095인 경우 확장 크기 사용:
```
DWORD tagId;           // 태그 (크기 = 4095)
DWORD extendedSize;    // 실제 크기
BYTE data[extendedSize];
```

## 압축된 스트림 구조

압축된 스트림의 구조:
```
struct CompressedStream {
    BYTE compressedData[];  // zlib 압축 데이터
}
```

압축 해제 후 원본 스트림 구조를 따름

## 텍스트 인코딩

### 문자열 저장 방식
1. **고정 길이**: WCHAR[n] 형태
2. **가변 길이**: 길이 + WCHAR[] 형태
   ```
   WORD length;        // 문자 개수
   WCHAR text[length]; // UTF-16 LE 텍스트
   ```

### 특수 문자 코드
- 0x0000: 예약
- 0x0001: 예약  
- 0x0002: 구역 정의
- 0x0003: 필드 시작
- 0x0004: 필드 끝
- 0x0005: 예약
- 0x0006: 예약
- 0x0007: 예약
- 0x0008: 제목
- 0x0009: 탭
- 0x000A: 강제 줄 나눔
- 0x000B: 그리기 객체/표
- 0x000C: 예약
- 0x000D: 문단 끝
- 0x000E-0x0017: 예약
- 0x0018: 하이픈
- 0x0019: 예약
- 0x001A: 예약
- 0x001B: 예약
- 0x001C: 예약
- 0x001D: 예약
- 0x001E: 묶음 빈칸
- 0x001F: 고정폭 빈칸

## 주의사항

1. **바이트 순서**: 모든 멀티바이트 값은 리틀 엔디안
2. **정렬**: 레코드는 4바이트 정렬되지 않음
3. **버전 호환성**: 알 수 없는 레코드는 건너뛰어야 함
4. **크기 계산**: 레코드 크기는 태그를 제외한 데이터 크기