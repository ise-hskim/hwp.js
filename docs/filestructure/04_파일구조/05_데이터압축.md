# 데이터 압축

한글 문서에서 사용하는 데이터 압축 방법에 대한 설명입니다.

## 압축 알고리즘

한글 문서는 **zlib** 압축 알고리즘을 사용합니다.

### zlib 특징
- Deflate 알고리즘 기반
- 업계 표준 압축 라이브러리
- 좋은 압축률과 빠른 속도의 균형
- CRC32 체크섬으로 데이터 무결성 검증

## 압축 대상 스트림

### 기본적으로 압축되는 스트림
1. **DocInfo**: 문서 정보
2. **BodyText/Section**: 본문 내용
3. **Scripts**: 스크립트 (있는 경우)

### 압축되지 않는 스트림
1. **FileHeader**: 파일 헤더 (항상 비압축)
2. **PrvText**: 미리보기 텍스트
3. **PrvImage**: 미리보기 이미지
4. **BinData**: 바이너리 데이터 (이미 압축된 형식)

## 압축 확인 방법

FileHeader의 flags 필드에서 압축 여부를 확인:

```c
struct FileHeader {
    // ... 다른 필드들 ...
    DWORD flags;
    // ... 다른 필드들 ...
};

// 압축 플래그 확인
bool isDocInfoCompressed = (flags & 0x01) != 0;
bool isBodyTextCompressed = (flags & 0x02) != 0;
bool isScriptCompressed = (flags & 0x04) != 0;
```

## 압축 데이터 구조

압축된 스트림은 다음과 같은 구조를 가집니다:

```
압축된 스트림 = zlib 헤더 + 압축된 데이터 + zlib 트레일러
```

### zlib 헤더 (2바이트)
- 첫 번째 바이트: 압축 방법 및 정보
- 두 번째 바이트: 플래그

일반적인 값: `0x78 0x9C` (기본 압축 레벨)

### zlib 트레일러 (4바이트)
- Adler-32 체크섬

## 압축 해제 과정

### 1. C/C++ 예제
```c
#include <zlib.h>

int decompress_stream(BYTE* compressed, DWORD compressed_size, 
                     BYTE** decompressed, DWORD* decompressed_size) {
    // 압축 해제 크기 예측 (보통 10배 정도)
    *decompressed_size = compressed_size * 10;
    *decompressed = malloc(*decompressed_size);
    
    // zlib 압축 해제
    int result = uncompress(*decompressed, decompressed_size, 
                           compressed, compressed_size);
    
    if (result == Z_BUF_ERROR) {
        // 버퍼 크기 부족 - 재할당 필요
        free(*decompressed);
        *decompressed_size *= 2;
        *decompressed = malloc(*decompressed_size);
        result = uncompress(*decompressed, decompressed_size, 
                           compressed, compressed_size);
    }
    
    return result;
}
```

### 2. Python 예제
```python
import zlib

def decompress_stream(compressed_data):
    try:
        decompressed = zlib.decompress(compressed_data)
        return decompressed
    except zlib.error as e:
        print(f"압축 해제 실패: {e}")
        return None
```

### 3. JavaScript 예제
```javascript
// pako 라이브러리 사용
const pako = require('pako');

function decompressStream(compressedData) {
    try {
        const decompressed = pako.inflate(compressedData);
        return decompressed;
    } catch (err) {
        console.error('압축 해제 실패:', err);
        return null;
    }
}
```

## 압축률

일반적인 압축률:
- **텍스트 위주 문서**: 70-90% 압축 (원본의 10-30% 크기)
- **이미지 포함 문서**: 20-40% 압축 (이미지는 이미 압축됨)
- **표 위주 문서**: 60-80% 압축

## 압축 레벨

한글은 기본적으로 zlib의 기본 압축 레벨(6)을 사용합니다.

압축 레벨별 특징:
- 0: 무압축 (저장만)
- 1-3: 빠른 압축 (낮은 압축률)
- 4-6: 균형잡힌 압축 (기본값)
- 7-9: 최대 압축 (느림)

## 오류 처리

압축 해제 시 발생 가능한 오류:
1. **Z_DATA_ERROR**: 손상된 압축 데이터
2. **Z_MEM_ERROR**: 메모리 부족
3. **Z_BUF_ERROR**: 출력 버퍼 부족
4. **Z_VERSION_ERROR**: zlib 버전 불일치

## 성능 최적화

1. **스트리밍 해제**: 큰 파일은 부분적으로 해제
2. **버퍼 재사용**: 반복적인 할당/해제 방지
3. **멀티스레딩**: 여러 스트림 병렬 처리
4. **캐싱**: 자주 사용하는 스트림 캐시

## 호환성 주의사항

1. **zlib 버전**: 1.2.x 이상 권장
2. **윈도우 크기**: 기본값(15비트) 사용
3. **사전**: 사전 압축 미사용
4. **raw deflate**: zlib 래퍼 포함 (raw deflate 아님)