# 문서 이력 관리 (Document History)

문서 이력 관리는 한글 2005(6.5.0.724), 문서 형식 버전(Doc 5.0.1.7)부터 지원하는 기능으로, 문서의 변경 이력을 추적하고 관리합니다.

## 개요

### 기능 설명
- 한글 메뉴의 "파일-문서 이력 관리"에서 표시 및 생성
- 한글 2005~2007: '버전 비교(파일-버전 비교)'라는 이름으로 제공
- 문서의 변경 사항을 시간 순서대로 기록

### 저장 구조
- **스토리지**: "DocHistory"
- **스트림**: VersionLog%d (%d는 버전 번호)
- **특징**: 압축 및 암호화되어 저장

### 용어 정의
- **히스토리/히스토리 아이템**: 문서 이력 정보의 각 항목
- 각 아이템은 특정 시점의 문서 상태를 나타냄

## 레코드 구조

### 히스토리 아이템 정보 시작

Tag ID: HISTORY_RECORD_TYPE_STAG (0x10)

#### 구조 (표 154)

| 자료형 | 길이(바이트) | 설명 |
|--------|------------|------|
| WORD | 2 | flag (포함 레코드 플래그) |
| UINT | 4 | option (버전 정보 관련 공통 옵션) |

#### Flag 비트 필드

| 비트 | 값 | 이름 | 설명 |
|------|-----|------|------|
| 0 | 0x01 | HISTORY_INFO_FLAG_VERSION | 버전 존재 |
| 1 | 0x02 | HISTORY_INFO_FLAG_DATE | 날짜 존재 |
| 2 | 0x04 | HISTORY_INFO_FLAG_WRITER | 작성자 존재 |
| 3 | 0x08 | HISTORY_INFO_FLAG_DESCRIPTION | 설명 존재 |
| 4 | 0x10 | HISTORY_INFO_FLAG_DIFFDATA | Diff Data 존재 |
| 5 | 0x20 | HISTORY_INFO_FLAG_LASTDOCDATA | 최근 문서 존재 (필수, 기록하지 않음) |
| 6 | 0x40 | HISTORY_INFO_FLAG_LOCK | 현재 히스토리 아이템 Lock 상태 |

#### Option 필드

| 값 | 이름 | 설명 |
|----|------|------|
| 0x00000001 | HWPVERSION_AUTOSAVE | 문서 저장 시 자동 저장 |

### 히스토리 아이템 정보 끝

Tag ID: HISTORY_RECORD_TYPE_ETAG (0x11)

#### 구조 (표 155)

| 내용 | 첨부 데이터 |
|------|------------|
| 히스토리 아이템 정보 끝 | NONE |

## 히스토리 아이템 구성

각 히스토리 아이템은 다음 정보를 포함할 수 있습니다:

### 기본 정보
1. **버전**: 문서 버전 번호
2. **날짜**: 저장 시점의 날짜/시간
3. **작성자**: 문서를 수정한 사용자 정보
4. **설명**: 변경 사항에 대한 설명

### 비교 정보
1. **Diff Data**: 이전 버전과의 차이점 데이터
2. **최근 문서**: 최근 문서의 전체 내용 (필수)

### 상태 정보
1. **Lock 상태**: 해당 버전의 수정 가능 여부
2. **자동 저장 여부**: 자동으로 저장된 버전인지 표시

## 문서 이력 활용

### 버전 비교
- 두 버전 간의 차이점 확인
- 변경된 내용 하이라이트 표시
- 추가/삭제/수정 내용 구분

### 버전 복원
- 이전 버전으로 문서 되돌리기
- 특정 시점의 문서 상태 복원

### 협업 관리
- 여러 작성자의 수정 이력 추적
- 수정 날짜와 작성자 확인
- 변경 사항에 대한 설명 첨부

## 저장 방식

### 압축
- 저장 공간 효율성을 위해 zlib 압축 사용
- 각 히스토리 아이템별로 개별 압축

### 암호화
- 문서 보안을 위한 암호화 적용
- 문서 암호와 연동된 암호화 키 사용

## 히스토리 아이템 상세 레코드

### 히스토리 아이템 버전 (표 156)
Tag ID: HISTORY_RECORD_TYPE_VERSION (0x20)

| 내용 | 데이터 타입 | 설명 |
|------|------------|------|
| 히스토리 아이템 버전 | DWORD | 버전 번호 (4바이트 정수) |

### 히스토리 날짜 (표 157)
Tag ID: HISTORY_RECORD_TYPE_DATE (0x21)

| 내용 | 데이터 타입 | 설명 |
|------|------------|------|
| 히스토리 날짜 | SYSTEMDATE | 시스템 날짜/시간 정보 |

SYSTEMDATE 구조:
- 년, 월, 일
- 시, 분, 초
- 요일 정보

### 히스토리 작성자 (표 158)
Tag ID: HISTORY_RECORD_TYPE_WRITER (0x22)

| 내용 | 데이터 타입 | 설명 |
|------|------------|------|
| 히스토리 작성자 | WCHAR | 작성자 이름 (유니코드 문자열) |

### 히스토리 설명 (표 159)
Tag ID: HISTORY_RECORD_TYPE_DESCRIPTION (0x23)

| 내용 | 데이터 타입 | 설명 |
|------|------------|------|
| 히스토리 설명 | WCHAR | 변경 사항 설명 (유니코드 문자열) |

### 비교 정보 (표 160)
Tag ID: HISTORY_RECORD_TYPE_DIFFDATA (0x30)

| 내용 | 데이터 타입 | 설명 |
|------|------------|------|
| 비교 정보 | WCHAR | DiffML 형식의 차이점 데이터 |

DiffML: 문서 간 차이를 XML 형식으로 표현한 데이터

### 가장 마지막 최근 문서 (표 161)
Tag ID: HISTORY_RECORD_TYPE_LASTDOCDATA (0x31)

| 내용 | 데이터 타입 | 설명 |
|------|------------|------|
| 가장 마지막 최근 문서 | WCHAR | HWPML 형식의 전체 문서 내용 |

HWPML: HWP 문서를 XML 형식으로 표현한 데이터

## 레코드 저장 순서

히스토리 아이템 저장 시:
1. **시작**: HISTORY_RECORD_TYPE_STAG (0x10)
2. **내용**: 
   - VERSION (0x20) - 선택적
   - DATE (0x21) - 선택적
   - WRITER (0x22) - 선택적
   - DESCRIPTION (0x23) - 선택적
   - DIFFDATA (0x30) - 선택적
   - LASTDOCDATA (0x31) - 필수
3. **종료**: HISTORY_RECORD_TYPE_ETAG (0x11)

## 제한 사항

### 저장 용량
- 히스토리 아이템 수 제한 (기본 100개)
- 전체 히스토리 크기 제한

### 성능 고려사항
- 히스토리가 많을수록 파일 크기 증가
- 자동 저장 시 성능 영향 고려 필요