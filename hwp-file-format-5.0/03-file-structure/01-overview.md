# 한글 파일 구조 요약

## 복합 파일 구조

한글의 문서 파일은 **개괄적으로** 다음 표와 같은 구조를 가집니다. **복합 파일(Compound File) 구조**를 가지기 때문에, 내부적으로 **스토리지(Storage)**와 **스트림(Stream)**을 구별하기 위한 이름을 가집니다.

하나의 스트림에는 일반적인 바이너리나 레코드 구조로 데이터가 저장되고, 스트림에 따라서 **압축/암호화**되기도 합니다.

## 전체 구조 표

| 설명                | 구별 이름                                                | 길이(바이트) | 레코드 구조 | 압축/암호화 |
| ------------------- | -------------------------------------------------------- | ------------ | ----------- | ----------- |
| **파일 인식 정보**  | FileHeader                                               | 고정(256)    |             |             |
| **문서 정보**       | DocInfo                                                  | 고정         | ✅          | ✅          |
| **본문**            | BodyText<br>- Section0<br>- Section1<br>- ...            | 가변         | ✅          | ✅          |
| **문서 요약**       | \005HwpSummaryInformation                                | 고정         |             |             |
| **바이너리 데이터** | BinData<br>- BinaryData0<br>- BinaryData1<br>- ...       | 가변         |             | (선택)      |
| **미리보기 텍스트** | PrvText                                                  | 고정         |             |             |
| **미리보기 이미지** | PrvImage                                                 | 가변         |             |             |
| **문서 옵션**       | DocOptions<br>- \_LinkDoc<br>- DrmLicense<br>- ...       | 가변         |             |             |
| **스크립트**        | Scripts<br>- DefaultJScript<br>- JScriptVersion<br>- ... | 가변         |             |             |
| **XML 템플릿**      | XMLTemplate<br>- Schema<br>- Instance<br>- ...           | 가변         |             |             |
| **문서 이력 관리**  | DocHistory<br>- VersionLog0<br>- VersionLog1<br>- ...    | 가변         | ✅          | ✅          |

> 범례: "레코드 구조" 열의 ✅는 해당 스토리지가 Tag ID 기반 레코드 스트림임을 의미합니다. "압축/암호화" 열의 ✅는 기본적으로 압축/암호화 대상임을, "(선택)"은 항목별 선택적 적용을 의미합니다.

## 파일 구조 다이어그램

```
HWP 파일
├─ FileHeader (256 bytes)          # 파일 인식 정보
├─ DocInfo/                        # 문서 정보 스토리지
│  ├─ 문서 속성
│  ├─ 글꼴 정보
│  ├─ 스타일 정보
│  └─ 기타 메타데이터
├─ BodyText/                       # 본문 스토리지
│  ├─ Section0                     # 첫 번째 구역
│  ├─ Section1                     # 두 번째 구역
│  └─ ...
├─ BinData/                        # 바이너리 데이터 스토리지
│  ├─ BinData0                     # 첫 번째 이미지/OLE
│  ├─ BinData1                     # 두 번째 이미지/OLE
│  └─ ...
├─ \005HwpSummaryInformation       # 문서 요약 정보
├─ PrvText                         # 미리보기 텍스트
├─ PrvImage                        # 미리보기 이미지
├─ DocOptions/                     # 문서 옵션 스토리지
│  ├─ \_LinkDoc                     # 연결 문서
│  ├─ DrmLicense                   # DRM 라이센스
│  └─ ...
├─ Scripts/                        # 스크립트 스토리지
│  ├─ DefaultJScript               # 기본 스크립트
│  ├─ JScriptVersion              # 스크립트 버전
│  └─ ...
├─ XMLTemplate/                    # XML 템플릿 스토리지
│  ├─ _SchemaName                  # 스키마 이름
│  ├─ Schema                       # 스키마
│  └─ Instance                     # 인스턴스
└─ DocHistory/                     # 문서 이력 스토리지
   ├─ VersionLog0                  # 버전 로그 0
   ├─ VersionLog1                  # 버전 로그 1
   ├─ ...
   └─ HistoryLastDoc               # 최종 문서
```

## 압축 처리

압축된 문서 파일의 경우 문서 파일을 읽는 쪽에서는 **'파일 인식 정보' 항목의 '압축' 플래그**를 살펴보고, 압축된 파일이면 **압축을 풀어서 처리**해야 합니다.

### 압축 대상

- **문서 정보** (DocInfo)
- **본문** (BodyText)
- **바이너리 데이터** (BinData) - 선택적
- **문서 이력 관리** (DocHistory)

### 압축되지 않는 부분

- **파일 인식 정보** (FileHeader)
- **문서 요약** (\005HwpSummaryInformation)
- **미리보기 텍스트** (PrvText)
- **미리보기 이미지** (PrvImage)
- **문서 옵션** (DocOptions)
- **스크립트** (Scripts)
- **XML 템플릿** (XMLTemplate)

## 레코드 구조

**'문서정보'**와 **'본문'** **'문서 이력 관리'**에 사용되는 **'레코드 구조'**는 이후 [데이터 레코드](../04-data-records/) 섹션에서 구조 설명과 사용되는 레코드들에 대한 상세한 설명을 다룹니다.

### 레코드 구조 특징

- **계층적 구조**: Level 필드를 통한 중첩 레코드 지원
- **확장 가능**: 미지 레코드는 크기만큼 건너뛰어 하위 호환성 보장
- **Tag ID 기반**: 각 레코드 타입을 고유 ID로 식별

## 개발 시 파일 읽기 순서

1. **FileHeader 읽기**
   - 압축 여부 확인
   - 암호화 여부 확인
   - 파일 버전 확인

2. **압축 해제** (필요시)
   - zlib을 사용하여 압축된 스트림 해제

3. **DocInfo 파싱**
   - 글꼴, 스타일, 문단 모양 등 메타데이터 수집

4. **BodyText 파싱**
   - 구역별로 순차 처리
   - 문단 단위로 텍스트와 컨트롤 처리

5. **BinData 처리**
   - 필요한 이미지/OLE 데이터 추출

6. **기타 정보 처리**
   - 문서 요약, 미리보기 등 추가 정보

---

_이후의 설명에서는 **압축이 풀린 상태의 파일**을 기준으로 합니다._

---

## 관련 표 (원문)

- 표 13: 문서 정보의 데이터 레코드(태그 목록)
- 표 57: 본문의 데이터 레코드 요약
